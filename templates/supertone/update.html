{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container mt-4">
  <div id="message-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050; width: auto;">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">컨텐츠 오디오 작성</h2>
  </div>
  <form method="post">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-end mb-3">
      {% bootstrap_field form.title wrapper="div" wrapper_class="flex-grow-1 me-3" label="제목" attrs="{'class': 'form-control form-control-sm'}" label_class="form-label small" %}
      <button type="submit" class="btn btn-primary">제목수정</button>
    </div>
    <div class="mb-3 d-flex justify-content-between">
      <a href="{% url 'supertone_list' %}" class="btn btn-secondary">목록으로</a>
      <div class="d-flex justify-content-between">
        <button type="button" id="regenerate-all" class="btn btn-outline-secondary me-2">
          전체 새로만들기
        </button>
        <button type="button" id="regenerate-missing" class="btn btn-outline-primary">
          음성 없는 것만 새로만들기
        </button>
      </div>
    </div>
    <div id="steps-container">
      {% if form.instance.pk %}
        {% for line in form.instance.lines.all %}
          <div class="card mb-4" data-line-id="{{ line.id }}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">{{ forloop.counter }}번 TTS</h6>
                <div class="d-flex">
                  <select name="voice_id_{{ forloop.counter }}" class="form-select w-auto me-2">
                    {% for voice in voice_list %}
                      <option value="{{ voice.voice_id }}" {% if voice.voice_id == line.voice.voice_id %}selected{% endif %}>{{ voice.name }}</option>
                    {% endfor %}
                  </select>
                  <select name="style_{{ forloop.counter }}" class="form-select w-auto">
                    {% for key, label in voice_styles %}
                      <option value="{{ key }}" {% if key == line.style %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <textarea name="step_{{ forloop.counter }}" class="form-control" rows="3">{{ line.text }}</textarea>
              </div>
              <div class="mb-3 audio-container">
                {% if line.audio_file %}
                  <audio controls class="w-100" src="{{ line.audio_file.url }}"></audio>
                {% else %}
                  <audio controls class="w-100"></audio>
                {% endif %}
              </div>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-sm btn-outline-secondary regenerate me-2" data-line-id="{{ line.id }}">
                  <i class="fas fa-sync-alt"></i> 새로만들기
                </button>
                {% if line.audio_file %}
                  <a href="{{ line.audio_file.url }}" download class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-download"></i> 다운로드
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </form>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ttsProxyUrl = "{% url 'tts_proxy' %}";
  const splitButton = document.getElementById('split-button');
  const generateButton = document.getElementById('generate-button');
  if (splitButton) splitButton.addEventListener('click', function() {
    const container = document.getElementById('steps-container');
    container.innerHTML = '';
    const contentField = document.getElementById('id_contents');
    const text = contentField.value;
    const segments = text.split(/[\n\.]+/).filter(s => s.trim());
    segments.forEach((seg, idx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'row mb-2 align-items-start';
      const colText = document.createElement('div');
      colText.className = 'col-md-6';
      const colAudio = document.createElement('div');
      colAudio.className = 'col-md-6 audio-container';
      const ta = document.createElement('textarea');
      ta.name = 'step_' + (idx + 1);
      ta.className = 'form-control';
      ta.rows = 3;
      ta.value = seg.trim();
      colText.appendChild(ta);
      wrapper.appendChild(colText);
      wrapper.appendChild(colAudio);
      const colActions = document.createElement('div');
      colActions.className = 'col-md-12 text-end mb-2';
      const segButton = document.createElement('button');
      segButton.type = 'button';
      segButton.className = 'btn btn-sm btn-secondary me-2';
      segButton.textContent = '생성하기';
      colActions.appendChild(segButton);
      wrapper.appendChild(colActions);
      segButton.addEventListener('click', async function() {
        const text = ta.value.trim();
        if (!text) return;
        try {
          const response = await fetch(ttsProxyUrl, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              voice_id: voiceId,
              text,
              language: 'ko',
              style: 'neutral',
              model: 'sona_speech_1'
            })
          });
          if (!response.ok) throw new Error('TTS error: '+response.statusText);
          const blob = await response.blob();
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = URL.createObjectURL(blob);
          const audioContainer = wrapper.querySelector('.audio-container');
          audioContainer.innerHTML = '';
          audioContainer.appendChild(audio);
        } catch (err) {
          console.error(err);
        }
      });
      container.appendChild(wrapper);
    });
    if (segments.length > 0) {
      generateButton.style.display = 'inline-block';
    }
  });
  if (generateButton) generateButton.addEventListener('click', async function() {
    generateButton.disabled = true;
    const container = document.getElementById('steps-container');
    const textareas = container.querySelectorAll('textarea[name^="step_"]');
    for (const ta of textareas) {
      const text = ta.value.trim();
      if (!text) continue;
      try {
        const wrapper = ta.closest('.card') || ta.closest('[data-line-id]');
        const style = wrapper.querySelector('select[name^="style_"]').value;
        const response = await fetch(ttsProxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            voice_id: voiceId,
            text,
            language: 'ko',
            style: style,
            model: 'sona_speech_1'
          })
        });
        if (!response.ok) throw new Error('TTS error: ' + response.statusText);
        const blob = await response.blob();
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = URL.createObjectURL(blob);
        const audioContainer = wrapper.querySelector('.audio-container');
        audioContainer.appendChild(audio);

            // Show temporary success alert for bulk generation
            const lineHeader = wrapper.querySelector('h6').textContent;
            const msgContainer = document.getElementById('message-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success fade show';
            successAlert.role = 'alert';
            successAlert.textContent = `${lineHeader} 음성이 생성되었습니다`;
            msgContainer.appendChild(successAlert);
            setTimeout(() => {
              successAlert.classList.remove('show');
              setTimeout(() => successAlert.remove(), 200);
            }, 3000);

      } catch (err) {
        console.error(err);
        let alertEl = document.querySelector('#tts-error-alert');
        if (!alertEl) {
          alertEl = document.createElement('div');
          alertEl.id = 'tts-error-alert';
          alertEl.className = 'alert alert-danger';
          document.querySelector('.container').prepend(alertEl);
        }
        alertEl.textContent = 'TTS 생성 중 오류가 발생했습니다: ' + (err.message || '알 수 없는 오류');
      }
    }
  });

  // Attach regenerate handlers
  document.querySelectorAll('.regenerate').forEach(button => {
    button.addEventListener('click', async function() {
      const btn = this;
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      // show spinner
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>생성중...';
      const lineId = btn.dataset.lineId;
      const wrapper = document.querySelector(`.card[data-line-id="${lineId}"]`);
      const textarea = wrapper.querySelector('textarea');
      const select = wrapper.querySelector('select[name^="voice_id_"]');
      const text = textarea.value.trim();
      const voice_id = select.value;
      if (!text) {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        return;
      }
      try {
        const style = wrapper.querySelector('select[name^="style_"]').value;
        const response = await fetch(ttsProxyUrl, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            line_id: lineId,
            voice_id: voice_id,
            text: text,
            language: 'ko',
            style: style,
            model: 'sona_speech_1'
          })
        });
        if (!response.ok) throw new Error('TTS error: '+response.statusText);
        const blob = await response.blob();
        const audioContainer = wrapper.querySelector('.audio-container');
        audioContainer.innerHTML = '';
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.className = 'w-100';
        audio.src = URL.createObjectURL(blob);
        audioContainer.appendChild(audio);

            // Show temporary success alert
            const lineHeader = wrapper.querySelector('h6').textContent;
            const msgContainer = document.getElementById('message-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success fade show';
            successAlert.role = 'alert';
            successAlert.textContent = `${lineHeader} 음성이 생성되었습니다`;
            msgContainer.appendChild(successAlert);
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
              successAlert.classList.remove('show');
              setTimeout(() => successAlert.remove(), 200);
            }, 3000);

      } catch (err) {
        console.error(err);
        const errorContainer = wrapper.querySelector('.audio-container');
        // Remove any existing error message
        let errorMsg = errorContainer.querySelector('.tts-error-message');
        if (!errorMsg) {
          errorMsg = document.createElement('div');
          errorMsg.className = 'tts-error-message alert alert-danger';
          errorContainer.appendChild(errorMsg);
        }
        // Set and update the text
        errorMsg.textContent = '오류 발생: ' + (err.message || '알 수 없는 오류');
        // Flash background then fade to transparent
        errorMsg.style.transition = 'background-color 0.5s ease-out';
        setTimeout(() => {
          errorMsg.style.backgroundColor = 'transparent';
        }, 2000);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    });
  });

  // Bulk "전체 새로만들기" - regenerate all lines
  const regenAllBtn = document.getElementById('regenerate-all');
  if (regenAllBtn) {
    regenAllBtn.addEventListener('click', function() {
      document.querySelectorAll('.regenerate').forEach(btn => btn.click());
    });
  }

  // Bulk "음성 없는 것만 새로만들기" - regenerate only missing audio
  const regenMissingBtn = document.getElementById('regenerate-missing');
  if (regenMissingBtn) {
    regenMissingBtn.addEventListener('click', function() {
      document.querySelectorAll('.card[data-line-id]').forEach(wrapper => {
        const audioEl = wrapper.querySelector('.audio-container audio');
        // If no src or empty src, trigger regenerate
        if (!audioEl || !audioEl.src) {
          const btn = wrapper.querySelector('.regenerate');
          if (btn) btn.click();
        }
      });
    });
  }
});
</script>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('message-container');
  if (container) {
    container.querySelectorAll('.alert').forEach(alert => {
      setTimeout(() => {
        alert.classList.remove('show');
        // after bootstrap fade transition (0.15s), remove from DOM
        setTimeout(() => alert.remove(), 200);
      }, 3000);
    });
  }
});
</script>
{% endblock %}
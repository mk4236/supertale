{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block content %}
<style>
  /* Hide default audio until Plyr is initialized */
  audio.plyr { visibility: hidden; }
</style>
<div class="container mt-4">
  <div id="message-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050; width: auto;">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div id="batch-progress" class="toast-container position-fixed top-0 end-0 p-3"></div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">컨텐츠 오디오 작성</h2>
  </div>
  <form method="post">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-end mb-3">
      {% bootstrap_field form.title wrapper="div" wrapper_class="flex-grow-1 me-3" label="제목" attrs="{'class': 'form-control form-control-sm'}" label_class="form-label small" %}
      <button type="submit" class="btn btn-primary">제목수정</button>
    </div>
    <div class="mb-3 d-flex justify-content-between">

      <div>
        <a href="{% url 'supertone_list' %}" class="btn btn-secondary btn-sm">목록으로</a>

        <button type="button" id="download-script" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-file-alt"></i> 스크립트 다운로드.srt
        </button>
        <a href="{% url 'supertone_download_zip' form.instance.pk %}" class="btn btn-success  btn-sm">
          <i class="fas fa-file-archive"></i> 오디오압축파일 다운로드.zip
        </a>
        <a href="{% url 'supertone_merge_audio' form.instance.pk %}"
          class="btn btn-success btn-sm">
          <i class="fas fa-download"></i>
          mp3 하나로 합쳐서 다운로드
        </a>
      </div>

      <div class="d-flex justify-content-between">
        <button type="button" id="regenerate-all" class="btn btn-outline-secondary me-2 btn-sm">
          전체 새로만들기
        </button>
        <button type="button" id="regenerate-missing" class="btn btn-outline-primary btn-sm">
          음성 없는 것만 새로만들기
        </button>
      </div>
    </div>
    <div id="steps-container">
      <!-- TTS Preview Section (like create view) -->
      <div class="card mb-4">
        <div class="card-body">
          <h6 class="mb-3">Preview</h6>
          <div class="row align-items-center mb-2">
            <div class="col d-flex flex-wrap gap-2">
              <div class="mb-0 me-2 col-auto">
                <img id="voice_thumbnail" src="" alt="Voice Thumbnail" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
              </div>
              <div class="mb-0 me-2 col-auto">
                <label for="id_voice" class="form-label small">음성</label>
                <div class="input-group input-group-sm">
                  <select name="voice" id="id_voice" class="form-select">
                    {% for voice in voice_list %}
                      <option value="{{ voice.voice_id }}" data-styles="{{ voice.styles }}" thumbnail-image-url="{{ voice.thumbnail_image_url }}" data-samples='{{ voice.samples }}' {% if voice.voice_id == form.voice.value %}selected{% endif %}>
                        {{ voice.name }}
                      </option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#voiceSearchModal">
                    상세검색
                  </button>
                </div>
              </div>
            </div>
            <div class="col-auto">
              <div class="mb-0 col-auto">
                <label for="id_style" class="form-label small">스타일</label>
                <select name="style" id="id_style" class="form-select form-select-sm w-auto">
                  {% for voice in voice_list %}
                    {% if voice.voice_id == form.voice.value %}
                      {% for style in voice.styles %}
                        <option value="{{ style }}" {% if style == form.style.value %}selected{% endif %}>{{form.style.value}}</option>
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-auto mb-0 me-2">
              <label for="id_pitch_shift" class="form-label small">음정 조정</label>
              <input type="number"
                     name="pitch_shift"
                     id="id_pitch_shift"
                     min="-12" max="12" step="1"
                     class="form-control w-auto form-control-sm"
                     value="{{ form.pitch_shift.value }}">
            </div>
            <div class="col-auto mb-0 me-2">
              <label for="id_pitch_variance" class="form-label small">억양 변화</label>
              <input type="number"
                     name="pitch_variance"
                     id="id_pitch_variance"
                     min="0.1" max="2" step="0.1"
                     class="form-control w-auto form-control-sm"
                     value="{{ form.pitch_variance.value }}">
            </div>
            <div class="col-auto mb-0">
              <label for="id_speed" class="form-label small">속도</label>
              <input type="number"
                     name="speed"
                     id="id_speed"
                     min="0.5" max="2" step="0.1"
                     class="form-control w-auto form-control-sm"
                     value="{{ form.speed.value }}">
            </div>
          </div>
          <div class="alert alert-secondary my-2 small text-muted" style="opacity:0.8;">
            <ul class="mb-0">
              <li><b>음정 조정 (pitch_shift):</b> 음정의 높낮이를 조정합니다. 0은 원래 보이스 음정이며, -12단계(낮음)에서 +12단계(높음)까지 조절 가능합니다.</li>
              <li><b>억양 변화 (pitch_variance):</b> 발화 중 억양의 변화 정도를 조절합니다. 값이 작을수록 평탄한 억양, 클수록 풍부한 억양을 생성하며 0.1에서 2 사이의 값을 가집니다.</li>
              <li><b>속도 (speed):</b> 발화 속도를 조절합니다. 1보다 작으면 느려지고, 크면 빨라지며 0.5에서 2 사이의 값을 가집니다.</li>
            </ul>
          </div>
          <div class="mb-3">
            <textarea id="preview-text" class="form-control" rows="2" placeholder="미리 듣고 싶은 텍스트를 입력하세요.">{{form.instance.text}}</textarea>
          </div>
          <div class="mb-3 audio-container">
            <audio id="preview-audio" controls class="plyr w-100"></audio>
            <audio id="voiceModalSampleAudio" style="display:none;"></audio>
            <audio id="line_audio_hidden" style="display:none;"></audio>
            <audio id="sample_audio_hidden" style="display:none;"></audio>
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" id="preview-button" class="btn btn-sm btn-outline-secondary ms-2">
              <i class="fas fa-play"></i> 미리듣기
            </button>
            <button type="button" id="apply-preview" class="btn btn-sm btn-outline-primary ms-2">
              <i class="fas fa-redo-alt"></i> 전체에 반영 및 음성 재생성
            </button>
          </div>
        </div>
      </div>
      {% if form.instance.pk %}
        {% for line in form.instance.lines.all %}
          <div class="card mb-4" data-line-id="{{ line.id }}">
            <div class="card-header"> 
              {{ forloop.counter }}번 TTS
            </div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="col-auto mb-0 me-2">
                    <label for="voice_id_{{ forloop.counter }}" class="form-label small">음성</label>
                    <div class="input-group input-group-sm w-auto align-items-center">
                      <img id="line_thumbnail_{{ forloop.counter }}" src="" alt="Line Thumbnail"
                           style="width:30px; height:30px; border-radius:50%; object-fit:cover; cursor:pointer; display:none;"
                           class="me-2">
                      <select name="voice_id_{{ forloop.counter }}" class="form-select">
                        {% for voice in voice_list %}
                          <option value="{{ voice.voice_id }}"
                                  data-styles="{{ voice.styles }}"
                                  thumbnail-image-url="{{ voice.thumbnail_image_url }}"
                                  data-samples='{{ voice.samples }}'
                                  {% if voice.voice_id == line.voice.voice_id %}selected{% endif %}>
                            {{ voice.name }}
                          </option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-outline-primary" type="button"
                              data-bs-toggle="modal" data-bs-target="#voiceSearchModal"
                              data-target-select="voice_id_{{ forloop.counter }}">
                        상세검색
                      </button>
                    </div>
                  </div>
                <div class="d-flex">
                  <div class="col-auto mb-0 me-2">
                    <label for="style_{{ forloop.counter }}" class="form-label small">스타일</label>
                    <select name="style_{{ forloop.counter }}" data-initial="{{ line.style }}" class="form-select w-auto form-select-sm"></select>
                  </div>
                  <div class="col-auto mb-0 me-2">
                    <label for="id_pitch_shift_{{ forloop.counter }}" class="form-label small">음정 조정</label>
                    <input type="number"
                           name="pitch_shift_{{ forloop.counter }}"
                           id="id_pitch_shift_{{ forloop.counter }}"
                           min="-12" max="12" step="1"
                           class="form-control w-auto form-control-sm"
                           value="{{ line.pitch_shift }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }">
                  </div>
                  <div class="col-auto mb-0 me-2">
                    <label for="id_pitch_variance_{{ forloop.counter }}" class="form-label small">억양 변화</label>
                    <input type="number"
                           name="pitch_variance_{{ forloop.counter }}"
                           id="id_pitch_variance_{{ forloop.counter }}"
                           min="0.1" max="2" step="0.1"
                           class="form-control w-auto form-control-sm"
                           value="{{ line.pitch_variance }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }">
                  </div>
                  <div class="col-auto mb-0 me-2">
                    <label for="id_speed_{{ forloop.counter }}" class="form-label small">속도</label>
                    <input type="number"
                           name="speed_{{ forloop.counter }}"
                           id="id_speed_{{ forloop.counter }}"
                           min="0.5" max="2" step="0.1"
                           class="form-control w-auto form-control-sm"
                           value="{{ line.speed }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }">
                  </div>
                  <div class="col-auto mb-0">
                    <label for="id_silent_{{ forloop.counter }}" class="form-label small">무음 길이(초)</label>
                    <input type="number"
                           name="silent_{{ forloop.counter }}"
                           id="id_silent_{{ forloop.counter }}"
                           data-line-id="{{ line.id }}"
                           min="0" step="0.1" max="600"
                           class="form-control w-auto form-control-sm"
                           value="{{ line.silent }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }"
                    >
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <textarea name="step_{{ forloop.counter }}" class="form-control" rows="2">{{ line.text }}</textarea>
              </div>
              <div class="d-flex justify-content-end align-items-center gap-2">
                <div>
                  {% if line.audio_file %}
                    <audio id="line_audio_{{ forloop.counter }}" controls class="plyr me-2" src="{{ line.audio_file.url }}"></audio>
                  {% else %}
                    <audio id="line_audio_{{ forloop.counter }}" controls class="plyr me-2"></audio>
                  {% endif %}
                </div>
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button"
                          class="btn btn-outline-primary regenerate"
                          data-line-id="{{ line.id }}">
                    <i class="fas fa-sync-alt"></i> 저장 및 음성생성
                  </button>
                  {% if line.audio_file %}
                    <a href="{{ line.audio_file.url }}"
                       download
                       class="btn btn-outline-secondary download-btn">
                      <i class="fas fa-download"></i> .mp3
                    </a>
                  {% else %}
                    <a href="#"
                       download
                       class="btn btn-outline-secondary download-btn d-none">
                      <i class="fas fa-download"></i>
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </form>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Prevent Enter key in preview inputs/selects from submitting the form
    ['id_voice','id_style','id_pitch_shift','id_pitch_variance','id_speed'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
          }
        });
      }
    });
    // Prevent Enter key in line-specific inputs/selects from submitting the form
    document.querySelectorAll(
      'select[name^="style_"], input[name^="pitch_shift_"], input[name^="pitch_variance_"], input[name^="speed_"], input[name^="silent_"]'
    ).forEach(el => {
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
        }
      });
    });
    const ttsUrl = "{% url 'tts_proxy' %}";
    // Handle preview buttons
    document.querySelectorAll('.regenerate').forEach(button => {
      button.addEventListener('click', async function() {
        const card = button.closest('.card');
        // gather parameters
        const text = card.querySelector('textarea').value.trim();
        // Line-specific voice and style selects
        const voiceSelect = card.querySelector('select[name^="voice_id_"]');
        // Derive the index from the select's name, e.g., 'voice_id_3' -> '3'
        const idx = voiceSelect ? voiceSelect.name.split('_')[2] : '';
        const styleSelect = (idx !== '')
          ? card.querySelector(`select[name="style_${idx}"]`)
          : null;
        const voice = voiceSelect ? voiceSelect.value : '';
        const style = styleSelect ? styleSelect.value : '';
        // Use prefix-matching selectors for numbered line inputs
        const psInput = card.querySelector('input[name^="pitch_shift_"]');
        const pitch_shift = psInput ? psInput.value : '';
        const pvInput = card.querySelector('input[name^="pitch_variance_"]');
        const pitch_variance = pvInput ? pvInput.value : '';
        const spInput = card.querySelector('input[name^="speed_"]');
        const speed = spInput ? spInput.value : '';
        if (!text) return;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        try {
          const response = await fetch(ttsUrl, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              voice_id: voice,
              text: text,
              style: style,
              language: '{{ form.language.value|default:"ko" }}',
              model: '{{ form.model.value|default:"sona_speech_1" }}',
              pitch_shift: pitch_shift,
              pitch_variance: pitch_variance,
              speed: speed,
              line_id: button.getAttribute('data-line-id')
            })
          });
          if (!response.ok) throw new Error('TTS error: '+response.statusText);
          const blob = await response.blob();
          // Determine index from voice select name
          const idx = voiceSelect ? voiceSelect.name.split('_')[2] : '';
          // Play on the corresponding line audio element within this card
          // const audio = document.getElementById(`line_audio_${idx}`);
          const audio = card.querySelector(`#line_audio_${idx}`);
          if (audio) {
            // If you want to also remove the pause-other-audios logic, comment out the next block:
            // document.querySelectorAll('audio').forEach(a => {
            //   if (a !== audio) {
            //     a.pause();
            //   }
            // });
            audio.src = URL.createObjectURL(blob);
            // Update download button to point to the new audio and show it
            const downloadBtn = card.querySelector('.download-btn');
            if (downloadBtn) {
              downloadBtn.href = audio.src;
              downloadBtn.style.display = 'inline-block';
            }
//            audio.play();  // Auto-play disabled on save
          }
        } catch (err) {
          console.error(err);
          // Show error toast in top-right
          const errToast = document.createElement('div');
          errToast.className = 'toast align-items-center text-white bg-danger border-0 mb-2';
          errToast.role = 'alert';
          errToast.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">음성 생성에 실패했습니다.</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>`;
          document.getElementById('batch-progress').appendChild(errToast);
          new bootstrap.Toast(errToast, { delay: 5000 }).show();
        } finally {
          button.disabled = false;
          button.innerHTML = '<i class="fas fa-sync-alt"></i> 저장 및 음성생성';
          // Signal this line's regeneration completed
          button.dispatchEvent(new Event('regenComplete'));
        }
      });
    });

    // 전체 새로만들기 버튼 기능 (parallelized version)
    const regenAllBtn = document.getElementById('regenerate-all');
    if (regenAllBtn) {
      regenAllBtn.addEventListener('click', () => {
        // Find all voice selects
        const selects = Array.from(document.querySelectorAll('select[name^="voice_id_"]'));
        const total = selects.length;

        // Build an array of regeneration promises
        const promises = selects.map(select => {
          const idx = select.name.split('_')[2];
          const card = select.closest('.card[data-line-id]');
          const btn  = card.querySelector('.regenerate');
          return new Promise(resolve => {
            btn.addEventListener('regenComplete', () => {
              // Per-line toast
              const toast = document.createElement('div');
              toast.className = 'toast align-items-center text-white bg-primary border-0 mb-2';
              toast.role      = 'alert';
              toast.innerHTML = `
                <div class="d-flex">
                  <div class="toast-body">${idx}번 라인 생성 완료</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>`;
              document.getElementById('batch-progress').appendChild(toast);
              new bootstrap.Toast(toast, { delay: 3000 }).show();
              resolve(idx);
            }, { once: true });
            btn.click();
          });
        });

        // When all done, show final toast
        Promise.all(promises).then(results => {
          const finalToast = document.createElement('div');
          finalToast.className = 'toast align-items-center text-white bg-success border-0 mb-2';
          finalToast.role      = 'alert';
          finalToast.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">전체 라인 음성 생성 완료! (${results.length}/${total})</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>`;
          document.getElementById('batch-progress').appendChild(finalToast);
          new bootstrap.Toast(finalToast, { delay: 5000 }).show();
        });
      });
    }

    // 음성 없는 것만 새로만들기 버튼 기능
    const regenMissingBtn = document.getElementById('regenerate-missing');
    if (regenMissingBtn) {
      regenMissingBtn.addEventListener('click', () => {
        // Gather all cards and filter missing
        const cards = Array.from(document.querySelectorAll('.card[data-line-id]'));
        const missingCards = cards.filter(card => {
          const audioEl = card.querySelector('audio');
          return !audioEl.getAttribute('src');
        });
        const total = missingCards.length;
        if (total === 0) {
          return;
        }
        // Trigger all missing regenerations in parallel
        const promises = missingCards.map(card => new Promise(async resolve => {
          const lineId = card.getAttribute('data-line-id');
          const btn = card.querySelector('.regenerate');
          // Ensure line styles are loaded
          const voiceSel = card.querySelector(`select[name="voice_id_${lineId}"]`);
          if (voiceSel) voiceSel.dispatchEvent(new Event('change'));
          // Listen for completion
          btn.addEventListener('regenComplete', () => {
            // After audio is regenerated, update download button
            const audioEl = card.querySelector(`audio#line_audio_${lineId}`);
            if (audioEl) {
              // Update download button and make it visible
              const downloadBtn = card.querySelector('.download-btn');
              if (downloadBtn) {
                // Set href to the new blob URL
                downloadBtn.href = audioEl.src;
                downloadBtn.style.display = 'inline-block';
              }
            }
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-primary border-0 mb-2';
            toast.role = 'alert';
            toast.innerHTML = `
              <div class="d-flex">
                <div class="toast-body">${lineId}번 라인 생성 완료 (${total}/${total})</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
              </div>`;
            document.getElementById('batch-progress').appendChild(toast);
            new bootstrap.Toast(toast, { delay: 3000 }).show();
            resolve(lineId);
          }, { once: true });
          // Trigger regeneration
          btn.click();
        }));
        // Final completion toast
        Promise.all(promises).then(results => {
          const finalToast = document.createElement('div');
          finalToast.className = 'toast align-items-center text-white bg-success border-0 mb-2';
          finalToast.role = 'alert';
          finalToast.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">음성 없는 라인 ${results.length}/${total} 생성 완료!</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>`;
          document.getElementById('batch-progress').appendChild(finalToast);
          new bootstrap.Toast(finalToast, { delay: 5000 }).show();
        });
      });
      // 페이지 로드 시 음성 없는 것만 자동 실행
      if (regenMissingBtn) {
      // 페이지 로드 시 음성 없는 것만 자동 실행 (150ms 지연)
        setTimeout(() => regenMissingBtn.click(), 150);
      }
    }

    // 전체에 반영 버튼
    document.querySelectorAll('.apply-preview-values').forEach(button => {
      {% comment %} button.addEventListener('click', function() {
        const card = button.closest('.card');
        // 미리보기 영역 값 읽기
        const voice = card.querySelector('select[name="voice"]').value;
        const style = card.querySelector('select[name="style"]').value;
        const pitch_shift = card.querySelector('input[name="pitch_shift"]').value;
        const pitch_variance = card.querySelector('input[name="pitch_variance"]').value;
        const speed = card.querySelector('input[name="speed"]').value;

        // 폼의 실제 input/select에 값 반영
        document.getElementById('id_voice').value = voice;
        document.getElementById('id_style').value = style;
        document.getElementById('id_pitch_shift').value = pitch_shift;
        document.getElementById('id_pitch_variance').value = pitch_variance;
        document.getElementById('id_speed').value = speed;

        // select 값이 바뀌면 change 이벤트도 발생시켜야 스타일 등도 갱신됨
        document.getElementById('id_voice').dispatchEvent(new Event('change'));
        document.getElementById('id_style').dispatchEvent(new Event('change'));
      }); {% endcomment %}
    });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  /* ---------- GLOBAL PREVIEW ---------- */
  const previewUrl = "{% url 'tts_proxy_preview' %}";
  const previewBtn   = document.getElementById('preview-button');
  const previewText  = document.getElementById('preview-text');
  const previewAudio = document.getElementById('sample_audio_hidden');
  const voiceSelect  = document.getElementById('id_voice');
  const styleSelect  = document.getElementById('id_style');
  const psInput      = document.getElementById('id_pitch_shift');
  const pvInput      = document.getElementById('id_pitch_variance');
  const spInput      = document.getElementById('id_speed');

  async function doPreview() {
    const text = previewText.value.trim();
    if (!text) return;
    previewBtn.disabled = true;
    previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    try {
      const response = await fetch(previewUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          voice_id: voiceSelect.value,
          text,
          style: styleSelect.value,
          language: '{{ form.language.value|default:"ko" }}',
          model:    '{{ form.model.value|default:"sona_speech_1" }}',
          pitch_shift:    psInput.value,
          pitch_variance: pvInput.value,
          speed:          spInput.value,
        }),
      });
      if (!response.ok) throw new Error('TTS preview error: ' + response.statusText);
      const blob = await response.blob();
      // Stop other audio, play preview
      document.querySelectorAll('audio').forEach(a => a.pause());
      previewAudio.src = URL.createObjectURL(blob);
      previewAudio.play();
    } catch (err) {
      console.error(err);
      alert('미리듣기에 실패했습니다.');
    } finally {
      previewBtn.disabled = false;
      previewBtn.innerHTML = '<i class="fas fa-play"></i> 미리듣기';
    }
  }

  previewBtn.addEventListener('click', doPreview);
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const voiceSelect = document.getElementById('id_voice');
    const styleSelect = document.getElementById('id_style');
    function updateVoiceStyles() {
      // Get the selected option's data-styles attribute
      const opt = voiceSelect.options[voiceSelect.selectedIndex];
      let raw = opt.getAttribute('data-styles') || '[]';
      // Replace single quotes with double quotes for valid JSON
      raw = raw.replace(/'/g, '"');
      let styles;
      try {
        styles = JSON.parse(raw);
      } catch (e) {
        styles = [];
      }
      styleSelect.innerHTML = '';
      // Update voice thumbnail
      const thumbnailUrl = opt.getAttribute('thumbnail-image-url') || '';
      const thumbnailImg = document.getElementById('voice_thumbnail');
      if (thumbnailImg) {
        thumbnailImg.src = thumbnailUrl;
        thumbnailImg.style.pointerEvents = 'auto';
        // Play Korean sample on thumbnail click
        thumbnailImg.style.cursor = 'pointer';
        thumbnailImg.onclick = () => {
          console.log('Thumbnail clicked, raw samples:', opt.getAttribute('data-samples'));
          const samplesRaw = opt.getAttribute('data-samples') || '[]';
          // Fix Python-style quotes to valid JSON
          const fixedRaw = samplesRaw.replace(/'/g, '"');
          let samples;
          try {
            samples = JSON.parse(fixedRaw);
          } catch (err) {
            console.error('Failed to parse samples JSON:', err, fixedRaw);
            samples = [];
          }
          const koSample = samples.find(s => s.language === 'ko');
          if (koSample) {
            const sampleAudio = document.getElementById('sample_audio_hidden');
            sampleAudio.src = koSample.url;
            sampleAudio.play();
          }
        };
      }
      styles.forEach(function(name) {
        const o = document.createElement('option');
        o.value = name;
        o.textContent = name;
        styleSelect.appendChild(o);
      });
    }
    voiceSelect.addEventListener('change', () => {
      // Pause any playing sample audio when voice changes
      const sampleAudio = document.getElementById('sample_audio_hidden');
      if (sampleAudio && !sampleAudio.paused) {
        sampleAudio.pause();
        sampleAudio.currentTime = 0;
      }
      updateVoiceStyles();
    });
    updateVoiceStyles();  // initialize on load
  });
</script>
{% include "supertone/voice_search_modal.html" %}
<script>
(function(){
  const modalEl = document.getElementById('voiceSearchModal');
  const form    = modalEl.querySelector('#voice-search-form');
  const results = modalEl.querySelector('#voice-search-results');
  const pager   = modalEl.querySelector('.pagination');
  let   debounceTimer;
  const audioHidden = document.getElementById('voiceModalSampleAudio');

  // Remember which select opened the modal
  document.querySelectorAll('button[data-bs-target="#voiceSearchModal"]').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target-select') || 'voice';
      modalEl.setAttribute('data-target-select', target);
    });
  });

  async function doSearch() {
    // Pause any playing audio before starting a new search
    if (audioHidden && !audioHidden.paused) {
      audioHidden.pause();
      audioHidden.currentTime = 0;
    }
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      const params = new URLSearchParams(new FormData(form));
      const resp   = await fetch("{% url 'voice_search' %}?" + params, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const html = await resp.text();
      const doc  = new DOMParser().parseFromString(html, 'text/html');
      results.innerHTML = doc.querySelector('#voice-search-results').innerHTML;
      pager.innerHTML   = doc.querySelector('.pagination').innerHTML;
      form.querySelector('input[name="q"]').focus();
    }, 300);
  }

  // Real-time search by name
  const nameInput = form.querySelector('input[name="q"]');
  nameInput.addEventListener('input', doSearch);
  nameInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      e.stopPropagation();
      doSearch();
    }
  });

  // Real-time filters: gender, style, user_case
  ['gender','style','user_case', 'age'].forEach(field => {
    const sel = form.querySelector(`select[name="${field}"]`);
    if (sel) sel.addEventListener('change', doSearch);
  });

  // Pagination links
  modalEl.addEventListener('click', e => {
    const a = e.target.closest('.pagination a.page-link');
    if (!a) return;
    // Pause audio when changing page
    if (audioHidden && !audioHidden.paused) {
      audioHidden.pause();
      audioHidden.currentTime = 0;
    }
    e.preventDefault();
    fetch("{% url 'voice_search' %}" + a.getAttribute('href'), {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.text())
    .then(html => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      results.innerHTML = doc.querySelector('#voice-search-results').innerHTML;
      pager.innerHTML   = doc.querySelector('.pagination').innerHTML;
    });
  });

  // Delegate preview and select
  modalEl.addEventListener('click', e => {
    if (e.target.matches('.preview-btn')) {
      e.preventDefault();
      const audio = document.getElementById('voiceModalSampleAudio');
      let raw = e.target.getAttribute('data-samples') || '[]';
      raw = raw.replace(/&quot;/g, '"').replace(/'/g, '"');
      let samples = [];
      try { samples = JSON.parse(raw); } catch {}
      const ko = samples.find(s => s.language === 'ko');
      if (ko) { audio.src = ko.url; audio.play(); }
      return;
    }
    if (e.target.matches('.voice-select-btn')) {
      e.preventDefault();
      // Pause audio when selecting a voice
      if (audioHidden && !audioHidden.paused) {
        audioHidden.pause();
        audioHidden.currentTime = 0;
      }
      const voiceId = e.target.dataset.voiceId;
      // Determine which select to update
      const targetName = modalEl.getAttribute('data-target-select') || 'voice';
      const selector = targetName === 'voice'
        ? document.getElementById('id_voice')
        : document.querySelector(`select[name="${targetName}"]`);
      if (selector) {
        selector.value = voiceId;
        selector.dispatchEvent(new Event('change'));
      }
      bootstrap.Modal.getInstance(modalEl).hide();
    }
  });

  // Run initial load when modal opens
  modalEl.addEventListener('shown.bs.modal', () => doSearch());

  // Pause audio when modal is closed
  modalEl.addEventListener('hidden.bs.modal', () => {
    if (audioHidden && !audioHidden.paused) {
      audioHidden.pause();
      audioHidden.currentTime = 0;
    }
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('select[name^="voice_id_"]').forEach(function(select) {
    function updateStyles() {
      var opt = select.options[select.selectedIndex];
      var raw = opt.getAttribute('data-styles') || '[]';
      raw = raw.replace(/'/g, '"');
      var styles;
      try { styles = JSON.parse(raw); } catch { styles = []; }
      var idx = select.name.match(/voice_id_(\d+)/)[1];
      var styleSelect = document.querySelector('select[name="style_' + idx + '"]');
      // Remember current value (from data-initial attribute)
      var current = styleSelect.getAttribute('data-initial');
      styleSelect.innerHTML = '';
      styles.forEach(function(s) {
        var o = document.createElement('option');
        o.value = s;
        o.textContent = s;
        if (s === current) o.selected = true;
        styleSelect.appendChild(o);
      });

      // Update line-specific thumbnail and click-to-play
      var thumbnailImg = document.getElementById('line_thumbnail_' + idx);
      var thumbnailUrl = opt.getAttribute('thumbnail-image-url') || '';
      if (thumbnailImg) {
        thumbnailImg.src = thumbnailUrl;
        thumbnailImg.style.display = thumbnailUrl ? 'inline-block' : 'none';
        thumbnailImg.onclick = function() {
          var raw = opt.getAttribute('data-samples') || '[]';
          var fixed = raw.replace(/'/g, '"');
          var samples = [];
          try { samples = JSON.parse(fixed); } catch (e) {}
          var ko = samples.find(function(s) { return s.language === 'ko'; });
          if (ko) {
            // Pause all other audio elements
            document.querySelectorAll('audio').forEach(a => a.pause());
            // Play via hidden preview audio
            var audio = document.getElementById('sample_audio_hidden');
            if (audio) {
              audio.src = ko.url;
              audio.play();
            }
          }
        };
      }
    }
    select.addEventListener('change', updateStyles);
    updateStyles();
  });
});
</script>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('message-container');
  if (container) {
    container.querySelectorAll('.alert').forEach(alert => {
      setTimeout(() => {
        alert.classList.remove('show');
        // after bootstrap fade transition (0.15s), remove from DOM
        setTimeout(() => alert.remove(), 200);
      }, 3000);
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const applyBtn = document.getElementById('apply-preview');
  if (!applyBtn) return;
  applyBtn.addEventListener('click', function() {
    // 1) Gather preview settings
    const previewVoice  = document.getElementById('id_voice').value;
    const previewStyle  = document.getElementById('id_style').value;
    const previewPS     = document.getElementById('id_pitch_shift').value;
    const previewPV     = document.getElementById('id_pitch_variance').value;
    const previewSpeed  = document.getElementById('id_speed').value;

    // 2) Locate all line cards
    const cards = Array.from(document.querySelectorAll('select[name^="voice_id_"]'));
    const total = cards.length;

    // 3) Prepare an array of regeneration promises
    const regenPromises = cards.map(select => {
      const idx = select.name.split('_')[2];
      const card = select.closest('.card[data-line-id]');
      // Apply preview settings to each field
      const vField = select;
      const sField = card.querySelector(`select[name="style_${idx}"]`);
      const psField = card.querySelector(`input[name="pitch_shift_${idx}"]`);
      const pvField = card.querySelector(`input[name="pitch_variance_${idx}"]`);
      const spField = card.querySelector(`input[name="speed_${idx}"]`);
      if (vField) { vField.value = previewVoice; vField.dispatchEvent(new Event('change')); }
      if (sField) { sField.value = previewStyle; sField.dispatchEvent(new Event('change')); }
      if (psField) psField.value = previewPS;
      if (pvField) pvField.value = previewPV;
      if (spField) spField.value = previewSpeed;

      // Return a promise that resolves on regenComplete
      return new Promise(resolve => {
        const btn = card.querySelector('.regenerate');
        btn.addEventListener('regenComplete', () => {
          // Show toast per line
          const toast = document.createElement('div');
          toast.className = 'toast align-items-center text-white bg-primary border-0 mb-2';
          toast.role = 'alert';
          toast.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">
                ${idx}번 라인 생성 완료
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>`;
          document.getElementById('batch-progress').appendChild(toast);
          new bootstrap.Toast(toast, { delay: 3000 }).show();
          resolve(idx);
        }, { once: true });
        // Trigger regeneration
        btn.click();
      });
    });

    // 4) When all lines are done, show a final toast
    Promise.all(regenPromises).then(() => {
      const finalToast = document.createElement('div');
      finalToast.className = 'toast align-items-center text-white bg-success border-0 mb-2';
      finalToast.role = 'alert';
      finalToast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">전체 라인 음성 생성 완료! (${total}/${total})</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      document.getElementById('batch-progress').appendChild(finalToast);
      new bootstrap.Toast(finalToast, { delay: 5000 }).show();
    });
  });
});
</script>
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize Plyr and reveal players
    const players = Plyr.setup('audio.plyr', {
      controls: ['play', 'progress', 'current-time', 'mute', 'volume']
    });
    players.forEach(player => {
      const container = player.elements.container;
      if (container) {
        container.style.visibility = 'visible';
      }
    });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('input[name^="silent_"]').forEach(input => {
    const updateSilent = async (e) => {
      const val = e.target.value;
      const idx = e.target.dataset.lineId;
      try {
        await fetch("{% url 'update_silent' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({ line_id: idx, silent: val }),
        });
      } catch(err) {
        console.error("Silent update failed:", err);
      }
    };
    input.addEventListener('blur', updateSilent);
    input.addEventListener('change', updateSilent);
  });
});
</script>
<script>
  // Generate and download SRT file based on line cards
  function formatTimestamp(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    const ms = Math.floor((seconds % 1) * 1000);
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')},${String(ms).padStart(3,'0')}`;
  }

  document.getElementById('download-script').addEventListener('click', () => {
    let srtContent = '';
    let cumulative = 0;
    document.querySelectorAll('.card[data-line-id]').forEach((card, index) => {
      const textArea = card.querySelector('textarea[name^="step_"]');
      const text = textArea ? textArea.value.trim() : '';
      const audioEl = card.querySelector('audio.plyr');
      const duration = audioEl && !isNaN(audioEl.duration) ? audioEl.duration : 0;
      const silentInput = card.querySelector('input[name^="silent_"]');
      const silent = silentInput ? parseFloat(silentInput.value) : 0;
      const start = cumulative;
      const end = start + duration;
      srtContent += `${index}\n`;
      srtContent += `${formatTimestamp(start)} --> ${formatTimestamp(end)}\n`;
      srtContent += `${text}\n\n`;
      cumulative = end + silent;
    });
    const blob = new Blob([srtContent], { type: 'application/x-subrip' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `supertone_{{ form.instance.pk }}.srt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
</script>
{% endblock %}
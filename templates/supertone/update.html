{% extends "base.html" %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container mt-4">
  <div id="message-container" style="position: fixed; top: 1rem; right: 1rem; z-index: 1050; width: auto;">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">컨텐츠 오디오 작성</h2>
  </div>
  <form method="post">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-end mb-3">
      {% bootstrap_field form.title wrapper="div" wrapper_class="flex-grow-1 me-3" label="제목" attrs="{'class': 'form-control form-control-sm'}" label_class="form-label small" %}
      <button type="submit" class="btn btn-primary">제목수정</button>
    </div>
    <div class="mb-3 d-flex justify-content-between">
      
      <div>
        <a href="{% url 'supertone_list' %}" class="btn btn-secondary btn-sm">목록으로</a>
        <a href="{% url 'supertone_download_zip' form.instance.pk %}" class="btn btn-success ms-2 btn-sm">
          <i class="fas fa-file-archive"></i> 오디오 모음 다운로드
        </a>
        {% comment %} <a href="{% url 'supertone_merge_audio' form.instance.pk %}" 
          class="btn btn-success">
          mp3 합쳐서 다운로드
        </a> {% endcomment %}
      </div>

      <div class="d-flex justify-content-between">
        <button type="button" id="regenerate-all" class="btn btn-outline-secondary me-2 btn-sm">
          전체 새로만들기
        </button>
        <button type="button" id="regenerate-missing" class="btn btn-outline-primary btn-sm">
          음성 없는 것만 새로만들기
        </button>
      </div>
    </div>
    <div id="steps-container">
      <!-- TTS Preview Section (like create view) -->
      <div class="card mb-4">
        <div class="card-body">
          <h6 class="mb-3">미리 듣기</h6>
          <div class="row align-items-center mb-2">
            <div class="col-auto">
              <div class="mb-0 me-2 col-auto">
              <label for="id_voice" class="form-label small">음성</label>
                <select name="voice" id="id_voice" class="form-select form-select-sm w-auto">
                  {% for voice in voice_list %}
                    <option value="{{ voice.voice_id }}" data-styles="{{ voice.styles }}" {% if voice.voice_id == form.voice.value %}selected{% endif %}>
                      {{ voice.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-auto">
              <div class="mb-0 me-2 col-auto">
                <label for="id_style" class="form-label small">음성 스타일</label>
                <select name="style" id="id_style" class="form-select form-select-sm w-auto">
                  {% for voice in voice_list %}
                    {% if voice.voice_id == form.voice.value %}
                      {% for style in voice.styles %}
                        <option value="{{ style }}" {% if style == form.style.value %}selected{% endif %}>{{ style }}</option>
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-auto">
              {% bootstrap_field form.pitch_shift label="음정 조정" wrapper="div" wrapper_class="mb-0" field_class="form-control form-control-sm w-auto" show_help=False attrs="{'type':'number','min':'-12','max':'12','step':'1'}" %}
            </div>
            <div class="col-auto">
              {% bootstrap_field form.pitch_variance label="억양 변화" wrapper="div" wrapper_class="mb-0" field_class="form-control form-control-sm w-auto" show_help=False attrs="{'type':'number','min':'0.1','max':'2','step':'0.1'}" %}
            </div>
            <div class="col-auto">
              {% bootstrap_field form.speed label="속도" wrapper="div" wrapper_class="mb-0" field_class="form-control form-control-sm w-auto" show_help=False attrs="{'type':'number','min':'0.5','max':'2','step':'0.1'}" %}
            </div>
          </div>
          <div class="alert alert-secondary my-2 small text-muted" style="opacity:0.8;">
            <ul class="mb-0">
              <li><b>음정 조정 (pitch_shift):</b> 음정의 높낮이를 조정합니다. 0은 원래 보이스 음정이며, -12단계(낮음)에서 +12단계(높음)까지 조절 가능합니다.</li>
              <li><b>억양 변화 (pitch_variance):</b> 발화 중 억양의 변화 정도를 조절합니다. 값이 작을수록 평탄한 억양, 클수록 풍부한 억양을 생성하며 0.1에서 2 사이의 값을 가집니다.</li>
              <li><b>속도 (speed):</b> 발화 속도를 조절합니다. 1보다 작으면 느려지고, 크면 빨라지며 0.5에서 2 사이의 값을 가집니다.</li>
            </ul>
          </div>
          <div class="mb-3">
            <textarea id="preview-text" class="form-control" rows="3" placeholder="미리 듣고 싶은 텍스트를 입력하세요.">{{form.instance.text}}</textarea>
          </div>
          <div class="mb-3 audio-container">
            <audio id="preview-audio" controls class="w-100"></audio>
          </div>
          <div class="d-flex justify-content-end">
            <button type="button" id="preview-button" class="btn btn-sm btn-outline-secondary">
              <i class="fas fa-play"></i> 미리듣기
            </button>
            <button type="button" id="apply-preview" class="btn btn-sm btn-outline-primary ms-2">
              <i class="fas fa-redo-alt"></i> 전체에 반영 및 음성 재생성
            </button>
          </div>
        </div>
      </div>
      {% if form.instance.pk %}
        {% for line in form.instance.lines.all %}
          <div class="card mb-4" data-line-id="{{ line.id }}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">{{ forloop.counter }}번 TTS</h6>
                <div class="d-flex">
                  <div class="col-auto mb-0 me-2">
                    <label for="voice_id_{{ forloop.counter }}" class="form-label small">음성</label>
                    <select name="voice_id_{{ forloop.counter }}" class="form-select w-auto me-2">
                      {% for voice in voice_list %}
                        <option value="{{ voice.voice_id }}" data-styles="{{ voice.styles|safe }}" {% if voice.voice_id == line.voice.voice_id %}selected{% endif %}>
                          {{ voice.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-auto mb-0 me-2">
                    <label for="style_{{ forloop.counter }}" class="form-label small">스타일</label>
                    <select name="style_{{ forloop.counter }}" class="form-select w-auto me-2"></select>
                  </div>
                  <div class="col-auto mb-0 me-2">
                    <label for="id_pitch_shift_{{ forloop.counter }}" class="form-label small">음정 조정</label>
                    <input type="number"
                           name="pitch_shift_{{ forloop.counter }}"
                           id="id_pitch_shift_{{ forloop.counter }}"
                           min="-12" max="12" step="1"
                           class="form-control w-auto"
                           value="{{ line.pitch_shift }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }">
                  </div>
                  <div class="col-auto mb-0 me-2">
                    <label for="id_pitch_variance_{{ forloop.counter }}" class="form-label small">억양 변화</label>
                    <input type="number"
                           name="pitch_variance_{{ forloop.counter }}"
                           id="id_pitch_variance_{{ forloop.counter }}"
                           min="0.1" max="2" step="0.1"
                           class="form-control w-auto"
                           value="{{ line.pitch_variance }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }">
                  </div>
                  <div class="col-auto mb-0">
                    <label for="id_speed_{{ forloop.counter }}" class="form-label small">속도</label>
                    <input type="number"
                           name="speed_{{ forloop.counter }}"
                           id="id_speed_{{ forloop.counter }}"
                           min="0.5" max="2" step="0.1"
                           class="form-control w-auto"
                           value="{{ line.speed }}"
                           onblur="var v=Number(this.value); var mn=Number(this.min); var mx=Number(this.max); if(isNaN(v)){ this.value = mn; } else { this.value = Math.max(Math.min(v, mx), mn); }">
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <textarea name="step_{{ forloop.counter }}" class="form-control" rows="3">{{ line.text }}</textarea>
              </div>
              <div class="mb-3 audio-container">
                {% if line.audio_file %}
                  <audio controls class="w-100" src="{{ line.audio_file.url }}"></audio>
                {% else %}
                  <audio controls class="w-100"></audio>
                {% endif %}
              </div>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-sm btn-outline-secondary regenerate me-2" data-line-id="{{ line.id }}">
                  <i class="fas fa-sync-alt"></i> 저장 및 음성생성
                </button>
                <a href="" download class="btn btn-sm btn-outline-secondary download-btn" style="display:none;">
                  <i class="fas fa-download"></i> 다운로드
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </form>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ttsProxyUrl = "{% url 'tts_proxy' %}";
  const splitButton = document.getElementById('split-button');
  const generateButton = document.getElementById('generate-button');
  if (splitButton) splitButton.addEventListener('click', function() {
    const container = document.getElementById('steps-container');
    container.innerHTML = '';
    const contentField = document.getElementById('id_contents');
    const text = contentField.value;
    const segments = text.split(/[\n\.]+/).filter(s => s.trim());
    segments.forEach((seg, idx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'row mb-2 align-items-start';
      const colText = document.createElement('div');
      colText.className = 'col-md-6';
      const colAudio = document.createElement('div');
      colAudio.className = 'col-md-6 audio-container';
      const ta = document.createElement('textarea');
      ta.name = 'step_' + (idx + 1);
      ta.className = 'form-control';
      ta.rows = 3;
      ta.value = seg.trim();
      colText.appendChild(ta);
      wrapper.appendChild(colText);
      wrapper.appendChild(colAudio);
      const colActions = document.createElement('div');
      colActions.className = 'col-md-12 text-end mb-2';
      const segButton = document.createElement('button');
      segButton.type = 'button';
      segButton.className = 'btn btn-sm btn-secondary me-2';
      segButton.textContent = '생성하기';
      colActions.appendChild(segButton);
      wrapper.appendChild(colActions);
      segButton.addEventListener('click', async function() {
        const text = ta.value.trim();
        if (!text) return;
        try {
          const response = await fetch(ttsProxyUrl, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              voice_id: voiceId,
              text,
              language: 'ko',
              style: 'neutral',
              model: 'sona_speech_1'
            })
          });
          if (!response.ok) throw new Error('TTS error: '+response.statusText);
          const blob = await response.blob();
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = URL.createObjectURL(blob);
          const audioContainer = wrapper.querySelector('.audio-container');
          audioContainer.innerHTML = '';
          audioContainer.appendChild(audio);
        } catch (err) {
          console.error(err);
        }
      });
      container.appendChild(wrapper);
    });
    if (segments.length > 0) {
      generateButton.style.display = 'inline-block';
    }
  });
  if (generateButton) generateButton.addEventListener('click', async function() {
    generateButton.disabled = true;
    const container = document.getElementById('steps-container');
    const textareas = container.querySelectorAll('textarea[name^="step_"]');
    for (const ta of textareas) {
      const text = ta.value.trim();
      if (!text) continue;
      try {
        const wrapper = ta.closest('.card') || ta.closest('[data-line-id]');
        const style = wrapper.querySelector('select[name^="style_"]').value;
        const pitchShift = wrapper.querySelector('input[name^="pitch_shift_"]').value;
        const pitchVariance = wrapper.querySelector('input[name^="pitch_variance_"]').value;
        const speedVal = wrapper.querySelector('input[name^="speed_"]').value;
        const response = await fetch(ttsProxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            voice_id: voiceId,
            text,
            language: 'ko',
            style: style,
            model: 'sona_speech_1',
            pitch_shift: pitchShift,
            pitch_variance: pitchVariance,
            speed: speedVal
          })
        });
        if (!response.ok) throw new Error('TTS error: ' + response.statusText);
        const blob = await response.blob();
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = URL.createObjectURL(blob);
        const audioContainer = wrapper.querySelector('.audio-container');
        audioContainer.appendChild(audio);

            // Show temporary success alert for bulk generation
            const lineHeader = wrapper.querySelector('h6').textContent;
            const msgContainer = document.getElementById('message-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success fade show';
            successAlert.role = 'alert';
            successAlert.textContent = `${lineHeader} 음성이 생성되었습니다`;
            msgContainer.appendChild(successAlert);
            setTimeout(() => {
              successAlert.classList.remove('show');
              setTimeout(() => successAlert.remove(), 200);
            }, 3000);

            // Show download button and set href
            const downloadBtn = wrapper.querySelector('.download-btn');
            if (downloadBtn) {
              downloadBtn.href = URL.createObjectURL(blob);
              downloadBtn.style.display = 'inline-block';
            }

      } catch (err) {
        console.error(err);
        let alertEl = document.querySelector('#tts-error-alert');
        if (!alertEl) {
          alertEl = document.createElement('div');
          alertEl.id = 'tts-error-alert';
          alertEl.className = 'alert alert-danger';
          document.querySelector('.container').prepend(alertEl);
        }
        alertEl.textContent = 'TTS 생성 중 오류가 발생했습니다: ' + (err.message || '알 수 없는 오류');
      }
    }
  });

  // Attach regenerate handlers
  document.querySelectorAll('.regenerate').forEach(button => {
    button.addEventListener('click', async function() {
      const btn = this;
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      // show spinner
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>생성중...';
      const lineId = btn.dataset.lineId;
      const wrapper = document.querySelector(`.card[data-line-id="${lineId}"]`);
      const textarea = wrapper.querySelector('textarea');
      const select = wrapper.querySelector('select[name^="voice_id_"]');
      const text = textarea.value.trim();
      const voice_id = select.value;
      if (!text) {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        return;
      }
      try {
        const style = wrapper.querySelector('select[name^="style_"]').value;
        const pitchShift = wrapper.querySelector('input[name^="pitch_shift_"]').value;
        const pitchVariance = wrapper.querySelector('input[name^="pitch_variance_"]').value;
        const speedVal = wrapper.querySelector('input[name^="speed_"]').value;
        const response = await fetch(ttsProxyUrl, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            line_id: lineId,
            voice_id: voice_id,
            text: text,
            language: 'ko',
            style: style,
            model: 'sona_speech_1',
            pitch_shift: pitchShift,
            pitch_variance: pitchVariance,
            speed: speedVal
          })
        });
        if (!response.ok) throw new Error('TTS error: '+response.statusText);
        const blob = await response.blob();
        const audioContainer = wrapper.querySelector('.audio-container');
        audioContainer.innerHTML = '';
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.className = 'w-100';
        audio.src = URL.createObjectURL(blob);
        audioContainer.appendChild(audio);

            // Show temporary success alert
            const lineHeader = wrapper.querySelector('h6').textContent;
            const msgContainer = document.getElementById('message-container');
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success fade show';
            successAlert.role = 'alert';
            successAlert.textContent = `${lineHeader} 음성이 생성되었습니다`;
            msgContainer.appendChild(successAlert);
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
              successAlert.classList.remove('show');
              setTimeout(() => successAlert.remove(), 200);
            }, 3000);

            // Show download button and set href
            const downloadBtn = wrapper.querySelector('.download-btn');
            if (downloadBtn) {
              downloadBtn.href = URL.createObjectURL(blob);
              downloadBtn.style.display = 'inline-block';
            }

      } catch (err) {
        console.error(err);
        const errorContainer = wrapper.querySelector('.audio-container');
        // Remove any existing error message
        let errorMsg = errorContainer.querySelector('.tts-error-message');
        if (!errorMsg) {
          errorMsg = document.createElement('div');
          errorMsg.className = 'tts-error-message alert alert-danger';
          errorContainer.appendChild(errorMsg);
        }
        // Set and update the text
        errorMsg.textContent = '오류 발생: ' + (err.message || '알 수 없는 오류');
        // Flash background then fade to transparent
        errorMsg.style.transition = 'background-color 0.5s ease-out';
        setTimeout(() => {
          errorMsg.style.backgroundColor = 'transparent';
        }, 2000);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    });
  });

  // Bulk "전체 새로만들기" - regenerate all lines
  const regenAllBtn = document.getElementById('regenerate-all');
  if (regenAllBtn) {
    regenAllBtn.addEventListener('click', function() {
      document.querySelectorAll('.regenerate').forEach(btn => btn.click());
    });
  }

  // Bulk "음성 없는 것만 새로만들기" - regenerate only missing audio
  const regenMissingBtn = document.getElementById('regenerate-missing');
  if (regenMissingBtn) {
    regenMissingBtn.addEventListener('click', function() {
      document.querySelectorAll('.card[data-line-id]').forEach(wrapper => {
        const audioEl = wrapper.querySelector('.audio-container audio');
        // If no src or empty src, trigger regenerate
        if (!audioEl || !audioEl.src) {
          const btn = wrapper.querySelector('.regenerate');
          if (btn) btn.click();
        }
      });
    });
  }

  // 자동으로 로딩 시 음성 없는 것만 새로만들기 실행
  if (regenMissingBtn) {
    regenMissingBtn.click();
  }

  // TTS preview in update view
  const previewBtn = document.getElementById('preview-button');
  if (previewBtn) {
    const previewUrl = "{% url 'tts_proxy_preview' %}";
    previewBtn.addEventListener('click', async function() {
      const textEl = document.getElementById('preview-text');
      const audioEl = document.getElementById('preview-audio');
      if (!textEl || !audioEl) return;
      const text = textEl.value.trim();
      if (!text) return;
      previewBtn.disabled = true;
      previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      try {
        const voice = document.querySelector('select[name="voice"]').value;
        const style = document.querySelector('select[name="style"]').value;
        const pitch_shift = document.querySelector('input[name="pitch_shift"]').value;
        const pitch_variance = document.querySelector('input[name="pitch_variance"]').value;
        const speed = document.querySelector('input[name="speed"]').value;
        const response = await fetch(previewUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            voice_id: voice,
            text: text,
            language: '{{ form.instance.language|default:"ko" }}',
            style: style,
            model: '{{ form.instance.model|default:"sona_speech_1" }}',
            pitch_shift: pitch_shift,
            pitch_variance: pitch_variance,
            speed: speed
          })
        });
        if (!response.ok) throw new Error('TTS error: ' + response.statusText);
        const blob = await response.blob();
        audioEl.src = URL.createObjectURL(blob);
        audioEl.play();
      } catch (err) {
        console.error(err);
        alert('음성 미리듣기에 실패했습니다: ' + (err.message || '알 수 없는 오류'));
      } finally {
        previewBtn.disabled = false;
        previewBtn.innerHTML = '<i class="fas fa-play"></i> 미리듣기';
      }
    });
  }
  // Apply preview settings and text to all lines and regenerate
  const applyBtn = document.getElementById('apply-preview');
  if (applyBtn) {
    applyBtn.addEventListener('click', function() {
      // Propagate selected preview options to each line's controls
      const previewVoice = document.querySelector('select[name="voice"]').value;
      const previewStyle = document.querySelector('select[name="style"]').value;
      const previewPitch = document.querySelector('input[name="pitch_shift"]').value;
      const previewVariance = document.querySelector('input[name="pitch_variance"]').value;
      const previewSpeed = document.querySelector('input[name="speed"]').value;

      document.querySelectorAll('select[name^="voice_id_"]').forEach(el => el.value = previewVoice);
      document.querySelectorAll('select[name^="style_"]').forEach(el => el.value = previewStyle);
      document.querySelectorAll('input[name^="pitch_shift_"]').forEach(el => el.value = previewPitch);
      document.querySelectorAll('input[name^="pitch_variance_"]').forEach(el => el.value = previewVariance);
      document.querySelectorAll('input[name^="speed_"]').forEach(el => el.value = previewSpeed);

      // trigger regenerate on all lines
      document.querySelectorAll('.regenerate').forEach(btn => btn.click());
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('select[name^="voice_id_"]').forEach(function(select) {
    function updateStyles() {
      var opt = select.options[select.selectedIndex];
      var raw = opt.getAttribute('data-styles') || '[]';
      raw = raw.replace(/'/g, '"');
      var styles;
      try { styles = JSON.parse(raw); } catch { styles = []; }
      var idx = select.name.match(/voice_id_(\d+)/)[1];
      var styleSelect = document.querySelector('select[name="style_' + idx + '"]');
      // Remember current value
      var current = styleSelect.value;
      styleSelect.innerHTML = '';
      styles.forEach(function(s) {
        var o = document.createElement('option');
        o.value = s;
        o.textContent = s;
        if (s === current) o.selected = true;
        styleSelect.appendChild(o);
      });
    }
    select.addEventListener('change', updateStyles);
    updateStyles();
  });
});
</script>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('message-container');
  if (container) {
    container.querySelectorAll('.alert').forEach(alert => {
      setTimeout(() => {
        alert.classList.remove('show');
        // after bootstrap fade transition (0.15s), remove from DOM
        setTimeout(() => alert.remove(), 200);
      }, 3000);
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const voiceSelect = document.getElementById('id_voice');
    const styleSelect = document.getElementById('id_style');
    function updateVoiceStyles() {
      // Get the selected option's data-styles attribute
      const opt = voiceSelect.options[voiceSelect.selectedIndex];
      let raw = opt.getAttribute('data-styles') || '[]';
      // Replace single quotes with double quotes for valid JSON
      raw = raw.replace(/'/g, '"');
      let styles;
      try {
        styles = JSON.parse(raw);
      } catch (e) {
        styles = [];
      }
      styleSelect.innerHTML = '';
      styles.forEach(function(name) {
        const o = document.createElement('option');
        o.value = name;
        o.textContent = name;
        styleSelect.appendChild(o);
      });
    }
    voiceSelect.addEventListener('change', updateVoiceStyles);
    updateVoiceStyles();  // initialize on load
  });
</script>
{% endblock %}